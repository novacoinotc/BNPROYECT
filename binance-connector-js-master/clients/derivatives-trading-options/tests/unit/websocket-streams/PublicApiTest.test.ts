/**
 * Binance Derivatives Trading Options WebSocket Market Streams
 *
 * OpenAPI Specification for the Binance Derivatives Trading Options WebSocket Market Streams
 *
 * The version of the OpenAPI document: 1.0.0
 *
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Do not edit the class manually.
 */

import { jest, expect, describe, it } from '@jest/globals';
import { JSONParse, JSONStringify } from 'json-with-bigint';
import {
    ConfigurationWebsocketStreams,
    WebsocketStreamsBase,
    replaceWebsocketStreamsPlaceholders,
} from '@binance/common';
import {
    DiffBookDepthStreamsRequest,
    IndividualSymbolBookTickerStreamsRequest,
    PartialBookDepthStreamsRequest,
    Ticker24HourRequest,
    TradeStreamsRequest,
} from '../../../src/websocket-streams';
import { PublicApi } from '../../../src/websocket-streams';
import { mockSubscription } from './utils';

describe('PublicApi', () => {
    describe('diffBookDepthStreams()', () => {
        it('should execute diffBookDepthStreams() successfully', async () => {
            const params: DiffBookDepthStreamsRequest = {
                symbol: 'btcusdt',
                id: 532601580,
                updateSpeed: 'updateSpeed_example',
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'depthUpdate',
                    E: 1762866729459,
                    T: 1762866729358,
                    s: 'BTC-251123-126000-C',
                    U: 465,
                    u: 465,
                    pu: 464,
                    b: [['1100.000', '0.6000']],
                    a: [['1300.000', '0.6000']],
                })
            );

            mockSubscription(
                `ws/${replaceWebsocketStreamsPlaceholders('/<symbol>@depth@<updateSpeed>'.slice(1), params as unknown as Record<string, DiffBookDepthStreamsRequest>)}`,
                mockResponse
            );
        });

        it('should handle diffBookDepthStreams() WebSocket stream data', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['public']);
            const websocketStreamApi = new PublicApi(websocketStreamClient);
            websocketStreamClient.connectionPool[0].urlPath = 'public';

            const params: DiffBookDepthStreamsRequest = {
                symbol: 'btcusdt',
                id: 532601580,
                updateSpeed: 'updateSpeed_example',
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'depthUpdate',
                    E: 1762866729459,
                    T: 1762866729358,
                    s: 'BTC-251123-126000-C',
                    U: 465,
                    u: 465,
                    pu: 464,
                    b: [['1100.000', '0.6000']],
                    a: [['1300.000', '0.6000']],
                })
            );

            const stream = websocketStreamApi.diffBookDepthStreams(params);
            const mockCallback = jest.fn(() => {});
            stream.on('message', mockCallback);

            websocketStreamClient['onMessage'](
                JSONStringify({
                    stream: replaceWebsocketStreamsPlaceholders(
                        '/<symbol>@depth@<updateSpeed>'.slice(1),
                        params as unknown as Record<string, DiffBookDepthStreamsRequest>
                    ),
                    data: mockResponse,
                }),
                websocketStreamClient.connectionPool[0]
            );

            expect(mockCallback).toHaveBeenCalledWith(mockResponse);
        });

        it('should throw RequiredError when symbol is missing', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['public']);
            const websocketStreamApi = new PublicApi(websocketStreamClient);

            const _params: DiffBookDepthStreamsRequest = {
                symbol: 'btcusdt',
            };
            const params = Object.assign({ ..._params });
            delete params?.symbol;

            expect(() => websocketStreamApi.diffBookDepthStreams(params)).toThrow(
                'Required parameter symbol was null or undefined when calling diffBookDepthStreams.'
            );
        });
    });

    describe('individualSymbolBookTickerStreams()', () => {
        it('should execute individualSymbolBookTickerStreams() successfully', async () => {
            const params: IndividualSymbolBookTickerStreamsRequest = {
                symbol: 'btcusdt',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'bookTicker',
                    u: 2472,
                    s: 'BTC-251226-110000-C',
                    b: '5000.000',
                    B: '0.2000',
                    a: '5100.000',
                    A: '0.1000',
                    T: 1763041762942,
                    E: 1763041762942,
                })
            );

            mockSubscription(
                `ws/${replaceWebsocketStreamsPlaceholders('/<symbol>@bookTicker'.slice(1), params as unknown as Record<string, IndividualSymbolBookTickerStreamsRequest>)}`,
                mockResponse
            );
        });

        it('should handle individualSymbolBookTickerStreams() WebSocket stream data', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['public']);
            const websocketStreamApi = new PublicApi(websocketStreamClient);
            websocketStreamClient.connectionPool[0].urlPath = 'public';

            const params: IndividualSymbolBookTickerStreamsRequest = {
                symbol: 'btcusdt',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'bookTicker',
                    u: 2472,
                    s: 'BTC-251226-110000-C',
                    b: '5000.000',
                    B: '0.2000',
                    a: '5100.000',
                    A: '0.1000',
                    T: 1763041762942,
                    E: 1763041762942,
                })
            );

            const stream = websocketStreamApi.individualSymbolBookTickerStreams(params);
            const mockCallback = jest.fn(() => {});
            stream.on('message', mockCallback);

            websocketStreamClient['onMessage'](
                JSONStringify({
                    stream: replaceWebsocketStreamsPlaceholders(
                        '/<symbol>@bookTicker'.slice(1),
                        params as unknown as Record<
                            string,
                            IndividualSymbolBookTickerStreamsRequest
                        >
                    ),
                    data: mockResponse,
                }),
                websocketStreamClient.connectionPool[0]
            );

            expect(mockCallback).toHaveBeenCalledWith(mockResponse);
        });

        it('should throw RequiredError when symbol is missing', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['public']);
            const websocketStreamApi = new PublicApi(websocketStreamClient);

            const _params: IndividualSymbolBookTickerStreamsRequest = {
                symbol: 'btcusdt',
            };
            const params = Object.assign({ ..._params });
            delete params?.symbol;

            expect(() => websocketStreamApi.individualSymbolBookTickerStreams(params)).toThrow(
                'Required parameter symbol was null or undefined when calling individualSymbolBookTickerStreams.'
            );
        });
    });

    describe('partialBookDepthStreams()', () => {
        it('should execute partialBookDepthStreams() successfully', async () => {
            const params: PartialBookDepthStreamsRequest = {
                symbol: 'btcusdt',
                level: 'example_value',
                id: 532601580,
                updateSpeed: 'updateSpeed_example',
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'depthUpdate',
                    E: 1762866729459,
                    T: 1762866729358,
                    s: 'BTC-251123-126000-C',
                    U: 465,
                    u: 465,
                    pu: 464,
                    b: [['1100.000', '0.6000']],
                    a: [['1300.000', '0.6000']],
                })
            );

            mockSubscription(
                `ws/${replaceWebsocketStreamsPlaceholders('/<symbol>@depth<level>@<updateSpeed>'.slice(1), params as unknown as Record<string, PartialBookDepthStreamsRequest>)}`,
                mockResponse
            );
        });

        it('should handle partialBookDepthStreams() WebSocket stream data', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['public']);
            const websocketStreamApi = new PublicApi(websocketStreamClient);
            websocketStreamClient.connectionPool[0].urlPath = 'public';

            const params: PartialBookDepthStreamsRequest = {
                symbol: 'btcusdt',
                level: 'example_value',
                id: 532601580,
                updateSpeed: 'updateSpeed_example',
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'depthUpdate',
                    E: 1762866729459,
                    T: 1762866729358,
                    s: 'BTC-251123-126000-C',
                    U: 465,
                    u: 465,
                    pu: 464,
                    b: [['1100.000', '0.6000']],
                    a: [['1300.000', '0.6000']],
                })
            );

            const stream = websocketStreamApi.partialBookDepthStreams(params);
            const mockCallback = jest.fn(() => {});
            stream.on('message', mockCallback);

            websocketStreamClient['onMessage'](
                JSONStringify({
                    stream: replaceWebsocketStreamsPlaceholders(
                        '/<symbol>@depth<level>@<updateSpeed>'.slice(1),
                        params as unknown as Record<string, PartialBookDepthStreamsRequest>
                    ),
                    data: mockResponse,
                }),
                websocketStreamClient.connectionPool[0]
            );

            expect(mockCallback).toHaveBeenCalledWith(mockResponse);
        });

        it('should throw RequiredError when symbol is missing', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['public']);
            const websocketStreamApi = new PublicApi(websocketStreamClient);

            const _params: PartialBookDepthStreamsRequest = {
                symbol: 'btcusdt',
                level: 'example_value',
            };
            const params = Object.assign({ ..._params });
            delete params?.symbol;

            expect(() => websocketStreamApi.partialBookDepthStreams(params)).toThrow(
                'Required parameter symbol was null or undefined when calling partialBookDepthStreams.'
            );
        });

        it('should throw RequiredError when level is missing', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['public']);
            const websocketStreamApi = new PublicApi(websocketStreamClient);

            const _params: PartialBookDepthStreamsRequest = {
                symbol: 'btcusdt',
                level: 'example_value',
            };
            const params = Object.assign({ ..._params });
            delete params?.level;

            expect(() => websocketStreamApi.partialBookDepthStreams(params)).toThrow(
                'Required parameter level was null or undefined when calling partialBookDepthStreams.'
            );
        });
    });

    describe('ticker24Hour()', () => {
        it('should execute ticker24Hour() successfully', async () => {
            const params: Ticker24HourRequest = {
                symbol: 'btcusdt',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: '24hrTicker',
                    E: 1764080707933,
                    s: 'ETH-251226-3000-C',
                    p: '0.0000',
                    P: '0.00',
                    w: '200.0000',
                    c: '200.0000',
                    Q: '1.0000',
                    o: '200.0000',
                    h: '200.0000',
                    l: '200.0000',
                    v: '9.0000',
                    q: '1800.0000',
                    O: 1764051060000,
                    C: 1764080707933,
                    F: 1,
                    L: 22,
                    n: 9,
                })
            );

            mockSubscription(
                `ws/${replaceWebsocketStreamsPlaceholders('/<symbol>@optionTicker'.slice(1), params as unknown as Record<string, Ticker24HourRequest>)}`,
                mockResponse
            );
        });

        it('should handle ticker24Hour() WebSocket stream data', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['public']);
            const websocketStreamApi = new PublicApi(websocketStreamClient);
            websocketStreamClient.connectionPool[0].urlPath = 'public';

            const params: Ticker24HourRequest = {
                symbol: 'btcusdt',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: '24hrTicker',
                    E: 1764080707933,
                    s: 'ETH-251226-3000-C',
                    p: '0.0000',
                    P: '0.00',
                    w: '200.0000',
                    c: '200.0000',
                    Q: '1.0000',
                    o: '200.0000',
                    h: '200.0000',
                    l: '200.0000',
                    v: '9.0000',
                    q: '1800.0000',
                    O: 1764051060000,
                    C: 1764080707933,
                    F: 1,
                    L: 22,
                    n: 9,
                })
            );

            const stream = websocketStreamApi.ticker24Hour(params);
            const mockCallback = jest.fn(() => {});
            stream.on('message', mockCallback);

            websocketStreamClient['onMessage'](
                JSONStringify({
                    stream: replaceWebsocketStreamsPlaceholders(
                        '/<symbol>@optionTicker'.slice(1),
                        params as unknown as Record<string, Ticker24HourRequest>
                    ),
                    data: mockResponse,
                }),
                websocketStreamClient.connectionPool[0]
            );

            expect(mockCallback).toHaveBeenCalledWith(mockResponse);
        });

        it('should throw RequiredError when symbol is missing', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['public']);
            const websocketStreamApi = new PublicApi(websocketStreamClient);

            const _params: Ticker24HourRequest = {
                symbol: 'btcusdt',
            };
            const params = Object.assign({ ..._params });
            delete params?.symbol;

            expect(() => websocketStreamApi.ticker24Hour(params)).toThrow(
                'Required parameter symbol was null or undefined when calling ticker24Hour.'
            );
        });
    });

    describe('tradeStreams()', () => {
        it('should execute tradeStreams() successfully', async () => {
            const params: TradeStreamsRequest = {
                symbol: 'btcusdt',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'trade',
                    E: 1762856064204,
                    T: 1762856064203,
                    s: 'BTC-251123-126000-C',
                    t: 4,
                    p: '1300.000',
                    q: '0.1000',
                    X: 'MARKET',
                    S: 'BUY',
                    m: false,
                })
            );

            mockSubscription(
                `ws/${replaceWebsocketStreamsPlaceholders('/<symbol>@optionTrade'.slice(1), params as unknown as Record<string, TradeStreamsRequest>)}`,
                mockResponse
            );
        });

        it('should handle tradeStreams() WebSocket stream data', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['public']);
            const websocketStreamApi = new PublicApi(websocketStreamClient);
            websocketStreamClient.connectionPool[0].urlPath = 'public';

            const params: TradeStreamsRequest = {
                symbol: 'btcusdt',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'trade',
                    E: 1762856064204,
                    T: 1762856064203,
                    s: 'BTC-251123-126000-C',
                    t: 4,
                    p: '1300.000',
                    q: '0.1000',
                    X: 'MARKET',
                    S: 'BUY',
                    m: false,
                })
            );

            const stream = websocketStreamApi.tradeStreams(params);
            const mockCallback = jest.fn(() => {});
            stream.on('message', mockCallback);

            websocketStreamClient['onMessage'](
                JSONStringify({
                    stream: replaceWebsocketStreamsPlaceholders(
                        '/<symbol>@optionTrade'.slice(1),
                        params as unknown as Record<string, TradeStreamsRequest>
                    ),
                    data: mockResponse,
                }),
                websocketStreamClient.connectionPool[0]
            );

            expect(mockCallback).toHaveBeenCalledWith(mockResponse);
        });

        it('should throw RequiredError when symbol is missing', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['public']);
            const websocketStreamApi = new PublicApi(websocketStreamClient);

            const _params: TradeStreamsRequest = {
                symbol: 'btcusdt',
            };
            const params = Object.assign({ ..._params });
            delete params?.symbol;

            expect(() => websocketStreamApi.tradeStreams(params)).toThrow(
                'Required parameter symbol was null or undefined when calling tradeStreams.'
            );
        });
    });
});
