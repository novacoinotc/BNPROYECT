/**
 * Binance Derivatives Trading Options WebSocket Market Streams
 *
 * OpenAPI Specification for the Binance Derivatives Trading Options WebSocket Market Streams
 *
 * The version of the OpenAPI document: 1.0.0
 *
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Do not edit the class manually.
 */

import { jest, expect, describe, it } from '@jest/globals';
import { JSONParse, JSONStringify } from 'json-with-bigint';
import {
    ConfigurationWebsocketStreams,
    WebsocketStreamsBase,
    replaceWebsocketStreamsPlaceholders,
} from '@binance/common';
import {
    IndexPriceStreamsRequest,
    KlineCandlestickStreamsRequest,
    MarkPriceRequest,
    NewSymbolInfoRequest,
    OpenInterestRequest,
} from '../../../src/websocket-streams';
import { MarketApi } from '../../../src/websocket-streams';
import { mockSubscription } from './utils';

describe('MarketApi', () => {
    describe('indexPriceStreams()', () => {
        it('should execute indexPriceStreams() successfully', async () => {
            const params: IndexPriceStreamsRequest = {
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify([
                    { e: 'indexPrice', E: 1763092572229, s: 'ETHUSDT', p: '3224.51976744' },
                    { e: 'indexPrice', E: 1763092572229, s: 'BTCUSDT', p: '99102.32326087' },
                ])
            );

            mockSubscription(
                `ws/${replaceWebsocketStreamsPlaceholders('/!index@arr'.slice(1), params as unknown as Record<string, IndexPriceStreamsRequest>)}`,
                mockResponse
            );
        });

        it('should handle indexPriceStreams() WebSocket stream data', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['market']);
            const websocketStreamApi = new MarketApi(websocketStreamClient);
            websocketStreamClient.connectionPool[0].urlPath = 'market';

            const params: IndexPriceStreamsRequest = {
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify([
                    { e: 'indexPrice', E: 1763092572229, s: 'ETHUSDT', p: '3224.51976744' },
                    { e: 'indexPrice', E: 1763092572229, s: 'BTCUSDT', p: '99102.32326087' },
                ])
            );

            const stream = websocketStreamApi.indexPriceStreams(params);
            const mockCallback = jest.fn(() => {});
            stream.on('message', mockCallback);

            websocketStreamClient['onMessage'](
                JSONStringify({
                    stream: replaceWebsocketStreamsPlaceholders(
                        '/!index@arr'.slice(1),
                        params as unknown as Record<string, IndexPriceStreamsRequest>
                    ),
                    data: mockResponse,
                }),
                websocketStreamClient.connectionPool[0]
            );

            expect(mockCallback).toHaveBeenCalledWith(mockResponse);
        });
    });

    describe('klineCandlestickStreams()', () => {
        it('should execute klineCandlestickStreams() successfully', async () => {
            const params: KlineCandlestickStreamsRequest = {
                symbol: 'btcusdt',
                interval: '1m',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'kline',
                    E: 1638747660000,
                    s: 'BTC-200630-9000-P',
                    k: {
                        t: 1638747660000,
                        T: 1638747719999,
                        s: 'BTC-200630-9000-P',
                        i: '1m',
                        f: 0,
                        L: 0,
                        o: '1000',
                        c: '1000',
                        h: '1000',
                        l: '1000',
                        v: '0',
                        n: 0,
                        x: false,
                        q: '0',
                        V: '0',
                        Q: '0',
                    },
                })
            );

            mockSubscription(
                `ws/${replaceWebsocketStreamsPlaceholders('/<symbol>@kline_<interval>'.slice(1), params as unknown as Record<string, KlineCandlestickStreamsRequest>)}`,
                mockResponse
            );
        });

        it('should handle klineCandlestickStreams() WebSocket stream data', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['market']);
            const websocketStreamApi = new MarketApi(websocketStreamClient);
            websocketStreamClient.connectionPool[0].urlPath = 'market';

            const params: KlineCandlestickStreamsRequest = {
                symbol: 'btcusdt',
                interval: '1m',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'kline',
                    E: 1638747660000,
                    s: 'BTC-200630-9000-P',
                    k: {
                        t: 1638747660000,
                        T: 1638747719999,
                        s: 'BTC-200630-9000-P',
                        i: '1m',
                        f: 0,
                        L: 0,
                        o: '1000',
                        c: '1000',
                        h: '1000',
                        l: '1000',
                        v: '0',
                        n: 0,
                        x: false,
                        q: '0',
                        V: '0',
                        Q: '0',
                    },
                })
            );

            const stream = websocketStreamApi.klineCandlestickStreams(params);
            const mockCallback = jest.fn(() => {});
            stream.on('message', mockCallback);

            websocketStreamClient['onMessage'](
                JSONStringify({
                    stream: replaceWebsocketStreamsPlaceholders(
                        '/<symbol>@kline_<interval>'.slice(1),
                        params as unknown as Record<string, KlineCandlestickStreamsRequest>
                    ),
                    data: mockResponse,
                }),
                websocketStreamClient.connectionPool[0]
            );

            expect(mockCallback).toHaveBeenCalledWith(mockResponse);
        });

        it('should throw RequiredError when symbol is missing', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['market']);
            const websocketStreamApi = new MarketApi(websocketStreamClient);

            const _params: KlineCandlestickStreamsRequest = {
                symbol: 'btcusdt',
                interval: '1m',
            };
            const params = Object.assign({ ..._params });
            delete params?.symbol;

            expect(() => websocketStreamApi.klineCandlestickStreams(params)).toThrow(
                'Required parameter symbol was null or undefined when calling klineCandlestickStreams.'
            );
        });

        it('should throw RequiredError when interval is missing', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['market']);
            const websocketStreamApi = new MarketApi(websocketStreamClient);

            const _params: KlineCandlestickStreamsRequest = {
                symbol: 'btcusdt',
                interval: '1m',
            };
            const params = Object.assign({ ..._params });
            delete params?.interval;

            expect(() => websocketStreamApi.klineCandlestickStreams(params)).toThrow(
                'Required parameter interval was null or undefined when calling klineCandlestickStreams.'
            );
        });
    });

    describe('markPrice()', () => {
        it('should execute markPrice() successfully', async () => {
            const params: MarkPriceRequest = {
                underlying: 'btcusdt',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify([
                    {
                        s: 'BTC-251120-126000-C',
                        mp: '770.543',
                        E: 1762867543321,
                        e: 'markPrice',
                        i: '104334.60217391',
                        P: '0.000',
                        bo: '0.000',
                        ao: '900.000',
                        bq: '0.0000',
                        aq: '0.2000',
                        b: '-1.0',
                        a: '0.98161161',
                        hl: '924.652',
                        ll: '616.435',
                        vo: '0.9408058',
                        rf: '0.0',
                        d: '0.11111964',
                        t: '-164.26702615',
                        g: '0.00001245',
                        v: '30.63855919',
                    },
                    {
                        s: 'BTC-251123-126000-C',
                        mp: '1249.61',
                        E: 1762867543321,
                        e: 'markPrice',
                        i: '104334.60217391',
                        P: '0.000',
                        bo: '1200.000',
                        ao: '1300.000',
                        bq: '0.3000',
                        aq: '0.6000',
                        b: '0.92159033',
                        a: '0.94461441',
                        hl: '1499.533',
                        ll: '999.688',
                        vo: '0.93310237',
                        rf: '0.0',
                        d: '0.14869196',
                        t: '-172.12148811',
                        g: '0.00001326',
                        v: '43.43627792',
                    },
                ])
            );

            mockSubscription(
                `ws/${replaceWebsocketStreamsPlaceholders('/<underlying>@optionMarkPrice'.slice(1), params as unknown as Record<string, MarkPriceRequest>)}`,
                mockResponse
            );
        });

        it('should handle markPrice() WebSocket stream data', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['market']);
            const websocketStreamApi = new MarketApi(websocketStreamClient);
            websocketStreamClient.connectionPool[0].urlPath = 'market';

            const params: MarkPriceRequest = {
                underlying: 'btcusdt',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify([
                    {
                        s: 'BTC-251120-126000-C',
                        mp: '770.543',
                        E: 1762867543321,
                        e: 'markPrice',
                        i: '104334.60217391',
                        P: '0.000',
                        bo: '0.000',
                        ao: '900.000',
                        bq: '0.0000',
                        aq: '0.2000',
                        b: '-1.0',
                        a: '0.98161161',
                        hl: '924.652',
                        ll: '616.435',
                        vo: '0.9408058',
                        rf: '0.0',
                        d: '0.11111964',
                        t: '-164.26702615',
                        g: '0.00001245',
                        v: '30.63855919',
                    },
                    {
                        s: 'BTC-251123-126000-C',
                        mp: '1249.61',
                        E: 1762867543321,
                        e: 'markPrice',
                        i: '104334.60217391',
                        P: '0.000',
                        bo: '1200.000',
                        ao: '1300.000',
                        bq: '0.3000',
                        aq: '0.6000',
                        b: '0.92159033',
                        a: '0.94461441',
                        hl: '1499.533',
                        ll: '999.688',
                        vo: '0.93310237',
                        rf: '0.0',
                        d: '0.14869196',
                        t: '-172.12148811',
                        g: '0.00001326',
                        v: '43.43627792',
                    },
                ])
            );

            const stream = websocketStreamApi.markPrice(params);
            const mockCallback = jest.fn(() => {});
            stream.on('message', mockCallback);

            websocketStreamClient['onMessage'](
                JSONStringify({
                    stream: replaceWebsocketStreamsPlaceholders(
                        '/<underlying>@optionMarkPrice'.slice(1),
                        params as unknown as Record<string, MarkPriceRequest>
                    ),
                    data: mockResponse,
                }),
                websocketStreamClient.connectionPool[0]
            );

            expect(mockCallback).toHaveBeenCalledWith(mockResponse);
        });

        it('should throw RequiredError when underlying is missing', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['market']);
            const websocketStreamApi = new MarketApi(websocketStreamClient);

            const _params: MarkPriceRequest = {
                underlying: 'btcusdt',
            };
            const params = Object.assign({ ..._params });
            delete params?.underlying;

            expect(() => websocketStreamApi.markPrice(params)).toThrow(
                'Required parameter underlying was null or undefined when calling markPrice.'
            );
        });
    });

    describe('newSymbolInfo()', () => {
        it('should execute newSymbolInfo() successfully', async () => {
            const params: NewSymbolInfoRequest = {
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'optionSymbol',
                    E: 1669356423908,
                    s: 'BTC-250926-140000-C',
                    ps: 'BTCUSDT',
                    qa: 'USDT',
                    d: 'CALL',
                    sp: '21000',
                    dt: 4133404800000,
                    u: 1,
                    ot: 1569398400000,
                    cs: 'TRADING',
                })
            );

            mockSubscription(
                `ws/${replaceWebsocketStreamsPlaceholders('/!optionSymbol'.slice(1), params as unknown as Record<string, NewSymbolInfoRequest>)}`,
                mockResponse
            );
        });

        it('should handle newSymbolInfo() WebSocket stream data', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['market']);
            const websocketStreamApi = new MarketApi(websocketStreamClient);
            websocketStreamClient.connectionPool[0].urlPath = 'market';

            const params: NewSymbolInfoRequest = {
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify({
                    e: 'optionSymbol',
                    E: 1669356423908,
                    s: 'BTC-250926-140000-C',
                    ps: 'BTCUSDT',
                    qa: 'USDT',
                    d: 'CALL',
                    sp: '21000',
                    dt: 4133404800000,
                    u: 1,
                    ot: 1569398400000,
                    cs: 'TRADING',
                })
            );

            const stream = websocketStreamApi.newSymbolInfo(params);
            const mockCallback = jest.fn(() => {});
            stream.on('message', mockCallback);

            websocketStreamClient['onMessage'](
                JSONStringify({
                    stream: replaceWebsocketStreamsPlaceholders(
                        '/!optionSymbol'.slice(1),
                        params as unknown as Record<string, NewSymbolInfoRequest>
                    ),
                    data: mockResponse,
                }),
                websocketStreamClient.connectionPool[0]
            );

            expect(mockCallback).toHaveBeenCalledWith(mockResponse);
        });
    });

    describe('openInterest()', () => {
        it('should execute openInterest() successfully', async () => {
            const params: OpenInterestRequest = {
                expirationDate: '220930',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify([
                    {
                        e: 'openInterest',
                        E: 1668759300045,
                        s: 'ETH-221125-2700-C',
                        o: '1580.87',
                        h: '1912992.178168204',
                    },
                ])
            );

            mockSubscription(
                `ws/${replaceWebsocketStreamsPlaceholders('/underlying@optionOpenInterest@<expirationDate>'.slice(1), params as unknown as Record<string, OpenInterestRequest>)}`,
                mockResponse
            );
        });

        it('should handle openInterest() WebSocket stream data', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['market']);
            const websocketStreamApi = new MarketApi(websocketStreamClient);
            websocketStreamClient.connectionPool[0].urlPath = 'market';

            const params: OpenInterestRequest = {
                expirationDate: '220930',
                id: 532601580,
            };

            const mockResponse = JSONParse(
                JSONStringify([
                    {
                        e: 'openInterest',
                        E: 1668759300045,
                        s: 'ETH-221125-2700-C',
                        o: '1580.87',
                        h: '1912992.178168204',
                    },
                ])
            );

            const stream = websocketStreamApi.openInterest(params);
            const mockCallback = jest.fn(() => {});
            stream.on('message', mockCallback);

            websocketStreamClient['onMessage'](
                JSONStringify({
                    stream: replaceWebsocketStreamsPlaceholders(
                        '/underlying@optionOpenInterest@<expirationDate>'.slice(1),
                        params as unknown as Record<string, OpenInterestRequest>
                    ),
                    data: mockResponse,
                }),
                websocketStreamClient.connectionPool[0]
            );

            expect(mockCallback).toHaveBeenCalledWith(mockResponse);
        });

        it('should throw RequiredError when expirationDate is missing', () => {
            const configuration = new ConfigurationWebsocketStreams({});
            const websocketStreamClient = new WebsocketStreamsBase(configuration, [], ['market']);
            const websocketStreamApi = new MarketApi(websocketStreamClient);

            const _params: OpenInterestRequest = {
                expirationDate: '220930',
            };
            const params = Object.assign({ ..._params });
            delete params?.expirationDate;

            expect(() => websocketStreamApi.openInterest(params)).toThrow(
                'Required parameter expirationDate was null or undefined when calling openInterest.'
            );
        });
    });
});
