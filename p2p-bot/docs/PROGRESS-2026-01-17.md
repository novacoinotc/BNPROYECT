# P2P Bot - Progress Report 2026-01-17

## Summary

Fixed critical issue where bank payments were not being linked to orders because `buyerRealName` was NULL in the database when payments arrived before order details were fetched from Binance API.

---

## Issues Fixed This Session

### 1. Smart Match Not Finding Orders (FIXED)

**Problem:** When a bank payment arrived (e.g., from "RODOLFO BARTOLANO REYES"), the smart match function couldn't find the correct order because:
- The order existed in DB but `buyerRealName` was NULL
- The Binance list orders API doesn't include buyer's real name
- Smart match fell back to comparing against censored `buyerNickName` like "User-8a84d"
- Comparison failed, payment stayed PENDING

**Solution:** Pre-populate `buyerRealName` before smart matching:

1. **Added `getOrdersNeedingBuyerName()`** in `database-pg.ts`:
   - Finds PAID orders with matching amount that have NULL buyerRealName

2. **Added `updateOrderBuyerName()`** in `database-pg.ts`:
   - Updates the buyerRealName field for an order

3. **Modified `handleBankPayment()`** in `auto-release.ts`:
   - BEFORE calling `findOrderByAmountAndName()`, fetches missing buyer names from Binance API
   - Saves names to DB for future lookups

4. **Modified `startVerification()`** in `auto-release.ts`:
   - Now saves `buyerRealName` to DB when fetching order details

5. **Modified `handleSyncMatched()`** in `auto-release.ts`:
   - Now saves `buyerRealName` to DB when fetching order details

**Commit:** `c7e2c5a` - fix: Pre-populate buyerRealName before smart match to fix payment linking

---

## Flow After Fix

### When Payment Arrives First (Bidirectional Match)
```
1. Bank payment arrives: "RODOLFO BARTOLANO REYES" for $800
2. getOrdersNeedingBuyerName($800) finds PAID orders with NULL buyerRealName
3. For each order, fetch details from Binance API
4. API returns buyerName: "BARTOLANO REYES RODOLFO"
5. updateOrderBuyerName() saves to DB
6. findOrderByAmountAndName() now compares words:
   - senderWords: {rodolfo, bartolano, reyes}
   - buyerWords: {bartolano, reyes, rodolfo}
   - Match: 3/3 = 100%
7. Payment linked to correct order
8. Auto-release proceeds
```

### When Order Arrives First (Normal Flow)
```
1. Order detected as PAID
2. startVerification() fetches order detail from Binance
3. buyerRealName saved to DB
4. When payment arrives, smart match finds order with name already populated
5. Auto-release proceeds
```

---

## Files Modified

### `src/services/database-pg.ts`
- Added `getOrdersNeedingBuyerName(amount, tolerance)` - lines 478-503
- Added `updateOrderBuyerName(orderNumber, buyerRealName)` - lines 506-520

### `src/services/auto-release.ts`
- Modified `handleBankPayment()` - added PRE-MATCH step (lines 340-364)
- Modified `startVerification()` - saves buyerRealName to DB (lines 617-620)
- Modified `handleSyncMatched()` - saves buyerRealName to DB (lines 183-186)

---

## Verification from Production Logs

The fix is working correctly in production. Examples from logs:

### Smart Match Working (Payment After Order)
```
üîÑ [PRE-MATCH] Fetching buyer names for orders missing buyerRealName
üìã [ORDER DETAIL] Buyer identity fields
üìù [DB] Updated buyer real name for order
üîç [SMART MATCH] Searching for order by amount AND name
‚úÖ [SMART MATCH] Found order with matching amount AND name
‚úÖ [SMART MATCH] Payment matched to order by amount AND name
üí∞ Pago bancario recibido de MARIA DE JESUS PEREZ KANTUN
üîó ‚úÖ Pago vinculado por monto Y nombre (100% similitud)
‚úì CRYPTO RELEASED
```

### Bidirectional Match Working (Payment Before Order)
```
üì¶ Order PAID
üìù Comprador marc√≥ como pagado - Esperando confirmaci√≥n bancaria
üîç Found existing bank payment(s) for order
üìù [DB] Updated buyer real name for order
‚úÖ [SMART MATCH] Bank payment matched to order (payment arrived first, name verified)
üîó ‚úÖ Pago bancario vinculado por nombre (100% similitud)
‚úÖ ‚úÖ Nombre verificado: "LUIS EDUHART FLORES NEVARES" ‚âà "FLORES NEVARES LUIS EDUHART" (similitud: 100%)
‚úì CRYPTO RELEASED
```

### Name Matches (Different Word Order - All 100%)
| Bank Sender | Binance Buyer | Match |
|-------------|---------------|-------|
| MARIA DE JESUS PEREZ KANTUN | Perez kantun Maria De jesus | 100% |
| SANDRA JAZMIN CARRANZA LOPEZ | CARRANZA LOPEZ SANDRA JAZMIN | 100% |
| LUIS EDUHART FLORES NEVARES | FLORES NEVARES LUIS EDUHART | 100% |
| VALERII KIRAKOSIAN | KIRAKOSIAN VALERII | 100% |
| JAVIER SALGADO VALDES | SALGADO VALDES JAVIER | 100% |
| HECTOR FRANCISCO CORONADO CAMPOS | CORONADO CAMPOS HECTOR FRANCISCO | 100% |
| Edwin Rafael Balam Canul | BALAM CANUL EDWIN RAFAEL | 100% |
| YAMILIN MATA BORRERO | YAMILIN MATA BORRERO | 100% |
| CARLOS JAVIER ARIAS MOREY | ARIAS MOREY CARLOS JAVIER | 100% |

---

## Previous Fixes (From Earlier Sessions)

### Double-Spend Protection
- Added `isPaymentAlreadyReleased()` function
- Modified `matchPaymentToOrder()` to check if payment is RELEASED
- Added check in `executeRelease()` before releasing

### Unmatch Payment on Name Failure
- Added `unmatchPayment()` function
- When name verification fails, payment is unmatched and returns to PENDING

### Smart Matching (Name-First)
- Implemented `findOrderByAmountAndName()` for matching by amount AND name
- Prevents payment "bouncing" between orders with same amount

### Pending Payments Dashboard
- Created `/pending-payments` page for manual third-party resolution
- API endpoints: GET, POST, PATCH for `/api/pending-payments`
- Manual linking and resolve/ignore functionality

---

## Architecture Notes

### Binance API Field Mapping
- **API returns:** `buyerName` (KYC verified real name)
- **We store as:** `buyerRealName` in database
- **Mapping in:** `binance-client.ts` line 554

### Name Comparison Algorithm
- Normalize both names (lowercase, remove special chars)
- Split into word sets (filter words < 3 chars)
- Calculate word overlap: `matches / max(senderWords, buyerWords)`
- Match threshold: > 30% similarity

### Order Sources
- `listPendingOrders` - Does NOT include buyerName
- `getOrderDetail` - DOES include buyerName (as `buyerName`)

---

## Git Commits This Session

1. `c7e2c5a` - fix: Pre-populate buyerRealName before smart match to fix payment linking
2. `5c63010` - fix: Add TOTP code reuse protection to prevent API errors

### 2. TOTP Code Reuse Issue (FIXED)

**Problem:** When two releases happened within the same 30-second TOTP window, Binance rejected the second code due to replay protection. Example from logs:
- First release at 02:24:50 (ANA MAYRIN RAMOS SALAZAR - $2,100) - OK
- Second release at 02:24:52 (ANA KARINA MORENO JAIME - $2,100) - API Error

**Root Cause:** Same TOTP code generated for both releases (same 30-second window).

**Solution:** Added TOTP code reuse protection:
- Track `lastUsedWindow` in TOTPService
- Added `generateCodeWithReuseProtection()` method
- If current window was already used, wait for next window before generating code
- Updated index.ts to use the new safe code generation

**Files Modified:**
- `src/services/totp-service.ts` - Added reuse tracking and new method
- `src/index.ts` - Use `generateCodeWithReuseProtection()` instead of `generateCode()`

## Previous Session Commits

1. `379636c` - feat: Add pending payments dashboard for manual third-party resolution
2. `285c5ea` - fix: Smart matching - match by amount AND name to prevent bouncing
3. `30e5591` - fix: Add double-spend protection for payments
4. `d5668bb` - fix: Unmatch payment when name verification fails

---

## Status: WORKING

All auto-release functionality is working correctly:
- Smart match finding orders by amount AND name
- Bidirectional matching (payment before/after order)
- Name verification passing with different word orders
- Auto-release completing successfully
- Double-spend protection active
- TOTP code reuse protection active (waits for next window if needed)
- Pending payments dashboard available for manual resolution
